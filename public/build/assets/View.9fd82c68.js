import{I as se,ad as oe,m as le,l as ne,d as w,K as re,e as v,r as c,o as d,j as g,h as i,b as a,z as S,t as m,a as t,c as $,F as Z,i as ie,g as b,ab as te,aO as ae,n as de,aa as ge,N as be,M as he,E as xe,P as Be,x as A,R as Y}from"./main.ecdeae84.js";import{_ as $e}from"./EstimateIndexDropdown.f2cbb440.js";import{_ as ke}from"./SendEstimateModal.ceaa6777.js";import{L as Ie}from"./LoadingIcon.a6b2c4b2.js";import"./mail-driver.4968d90d.js";const we={class:"flex justify-between w-full"},Se={class:"px-8 py-6"},Ee={key:0,class:"mb-6 p-4 bg-gray-50 rounded-md border border-gray-200"},Te={class:"text-sm font-semibold text-gray-700 mb-3"},Ve={class:"text-gray-600"},Me={key:0,class:"text-gray-400"},De=a("hr",{class:"my-3 border-gray-200"},null,-1),Fe={class:"flex justify-between items-center text-sm font-semibold"},Ae={class:"text-gray-700"},Ce={class:"flex gap-4 mt-2"},Ne={class:"flex items-center cursor-pointer"},Le={class:"ml-2 text-sm text-gray-700"},je={class:"flex items-center cursor-pointer"},Ue={class:"ml-2 text-sm text-gray-700"},ze={class:"relative"},Re={key:1,class:"mt-6 p-4 bg-gray-50 rounded-md border border-gray-200"},Pe={class:"flex justify-between items-center"},Ge={class:"text-sm font-medium text-gray-700"},He={class:"text-lg font-semibold text-gray-900"},Oe={class:"z-0 flex justify-end p-4 border-t border-gray-200 border-solid"},qe={__name:"DepositInvoiceModal",emits:["created"],setup(ue,{emit:G}){const h=se(),H=oe(),C=le(),{t:x}=ne(),l=w(!1),o=re({deposit_type:"percentage",deposit_value:30}),F=v(()=>h.active&&h.componentName==="DepositInvoiceModal"),B=v(()=>h.data||{}),E=v(()=>h.id),p=v(()=>{var s,n;return((n=(s=B.value)==null?void 0:s.customer)==null?void 0:n.currency)||null}),k=v(()=>{var s;return((s=B.value)==null?void 0:s.deposit_invoices)||[]}),N=v(()=>k.value.reduce((s,n)=>s+n.total,0)),T=v(()=>{var n;return(((n=B.value)==null?void 0:n.total)||0)-N.value}),r=v(()=>{var s,n;return(n=(s=p.value)==null?void 0:s.precision)!=null?n:2}),V=v(()=>{var n;const s=((n=B.value)==null?void 0:n.total)||0;if(!o.deposit_value||o.deposit_value<=0)return 0;if(o.deposit_type==="percentage")return Math.round(s*o.deposit_value/100);{const M=Math.pow(10,r.value);return Math.round(o.deposit_value*M)}}),L=v(()=>V.value>T.value&&T.value>0?x("estimates.deposit_exceeds_total"):null),j=v(()=>o.deposit_value>0&&V.value>0&&V.value<=T.value&&!l.value);async function O(){if(!!j.value){l.value=!0;try{const s=o.deposit_type==="fixed"?Math.round(o.deposit_value*Math.pow(10,r.value)):o.deposit_value,n=await H.createDepositInvoice(E.value,{deposit_type:o.deposit_type,deposit_value:s});n.data&&(I(),C.push(`/admin/invoices/${n.data.data.id}/edit`))}catch(s){console.error(s)}finally{l.value=!1}}}function I(){h.closeModal(),setTimeout(()=>{o.deposit_type="percentage",o.deposit_value=30},300)}return(s,n)=>{const M=c("BaseIcon"),f=c("BaseFormatMoney"),U=c("BaseInputGroup"),z=c("BaseInput"),q=c("BaseInputGrid"),R=c("BaseButton"),K=c("BaseModal");return d(),g(K,{show:F.value,onClose:I},{header:i(()=>[a("div",we,[S(m(s.$t("estimates.create_deposit_invoice"))+" ",1),t(M,{name:"XIcon",class:"h-6 w-6 text-gray-500 cursor-pointer",onClick:I})])]),default:i(()=>[a("div",Se,[k.value.length>0?(d(),$("div",Ee,[a("h4",Te,m(s.$t("estimates.existing_deposits")),1),(d(!0),$(Z,null,ie(k.value,e=>(d(),$("div",{key:e.id,class:"flex justify-between items-center text-sm py-1"},[a("span",Ve,[S(m(e.invoice_number)+" ",1),e.deposit_percentage?(d(),$("span",Me," ("+m(e.deposit_percentage)+"%) ",1)):b("",!0)]),t(f,{amount:e.total,currency:p.value},null,8,["amount","currency"])]))),128)),De,a("div",Fe,[a("span",Ae,m(s.$t("estimates.remaining_amount")),1),t(f,{amount:T.value,currency:p.value},null,8,["amount","currency"])])])):b("",!0),t(q,{layout:"one-column"},{default:i(()=>[t(U,{label:s.$t("estimates.deposit_type"),required:""},{default:i(()=>[a("div",Ce,[a("label",Ne,[te(a("input",{"onUpdate:modelValue":n[0]||(n[0]=e=>o.deposit_type=e),type:"radio",value:"percentage",class:"form-radio text-primary-500"},null,512),[[ae,o.deposit_type]]),a("span",Le,m(s.$t("estimates.percentage")),1)]),a("label",je,[te(a("input",{"onUpdate:modelValue":n[1]||(n[1]=e=>o.deposit_type=e),type:"radio",value:"fixed",class:"form-radio text-primary-500"},null,512),[[ae,o.deposit_type]]),a("span",Ue,m(s.$t("estimates.fixed_amount")),1)])])]),_:1},8,["label"]),t(U,{label:o.deposit_type==="percentage"?s.$t("estimates.percentage_value"):s.$t("estimates.deposit_amount"),required:"",error:L.value},{default:i(()=>[a("div",ze,[o.deposit_type==="percentage"?(d(),g(z,{key:0,modelValue:o.deposit_value,"onUpdate:modelValue":n[2]||(n[2]=e=>o.deposit_value=e),type:"number",min:"0.01",max:"100",step:"0.01",class:"mt-1"},null,8,["modelValue"])):(d(),g(z,{key:1,modelValue:o.deposit_value,"onUpdate:modelValue":n[3]||(n[3]=e=>o.deposit_value=e),type:"number",min:"0.01",step:"0.01",class:"mt-1"},null,8,["modelValue"]))])]),_:1},8,["label","error"])]),_:1}),V.value>0?(d(),$("div",Re,[a("div",Pe,[a("span",Ge,m(s.$t("estimates.deposit_amount")),1),a("span",He,[t(f,{amount:V.value,currency:p.value},null,8,["amount","currency"])])])])):b("",!0)]),a("div",Oe,[t(R,{class:"mr-3 text-sm",type:"button",variant:"primary-outline",onClick:I},{default:i(()=>[S(m(s.$t("general.cancel")),1)]),_:1}),t(R,{loading:l.value,disabled:!j.value,variant:"primary",type:"button",onClick:O},{left:i(e=>[l.value?b("",!0):(d(),g(M,{key:0,name:"SaveIcon",class:de(e.class)},null,8,["class"]))]),default:i(()=>[S(" "+m(s.$t("estimates.create_deposit_invoice")),1)]),_:1},8,["loading","disabled"])])]),_:1},8,["show"])}}},Ke={class:"mr-3 text-sm"},Xe={class:"fixed top-0 left-0 hidden h-full pt-16 pb-[6.4rem] ml-56 bg-white xl:ml-64 w-88 xl:block"},Je={class:"flex items-center justify-between px-4 pt-8 pb-2 border border-gray-200 border-solid height-full"},Qe={class:"mb-6"},We={class:"flex mb-6 ml-3",role:"group","aria-label":"First group"},Ye={class:"px-4 py-1 pb-2 mb-1 mb-2 text-sm border-b border-gray-200 border-solid"},Ze={class:"flex-2"},et={class:"mt-1 mb-2 text-xs not-italic font-medium leading-5 text-gray-600"},tt={class:"flex-1 whitespace-nowrap right"},at={class:"text-sm not-italic font-normal leading-5 text-right text-gray-600 est-date"},st={key:0,class:"flex justify-center p-4 items-center"},ot={key:1,class:"flex justify-center px-4 mt-5 text-sm text-gray-600"},lt={class:"flex flex-col min-h-0 mt-8 overflow-hidden",style:{height:"75vh"}},nt=["src"],mt={__name:"View",setup(ue){const G=se(),h=oe(),H=ge(),C=be(),{t:x}=ne(),l=w(null),o=he();le();const F=w(!1),B=w(!1),E=w(!1),p=w(null),k=w(1),N=w(1),T=w(null),r=re({orderBy:null,orderByField:null,searchText:null}),V=v(()=>l.value.estimate_number),L=v(()=>r.orderBy==="asc"||r.orderBy==null);v(()=>L.value?x("general.ascending"):x("general.descending"));const j=v(()=>`/estimates/pdf/${l.value.unique_hash}`);v(()=>l.value&&l.value.id?l.value.id:null),xe(o,(e,_)=>{e.name==="estimates.view"&&M()}),I(),M(),f=Be.exports.debounce(f,500);function O(e){return o.params.id==e}async function I(e,_=!1){if(B.value)return;let y={};r.searchText!==""&&r.searchText!==null&&r.searchText!==void 0&&(y.search=r.searchText),r.orderBy!==null&&r.orderBy!==void 0&&(y.orderBy=r.orderBy),r.orderByField!==null&&r.orderByField!==void 0&&(y.orderByField=r.orderByField),B.value=!0;let P=await h.fetchEstimates({page:e,...y});B.value=!1,p.value=p.value?p.value:[],p.value=[...p.value,...P.data.data],k.value=e||1,N.value=P.data.meta.last_page;let D=p.value.find(X=>X.id==o.params.id);_==!1&&!D&&k.value<N.value&&Object.keys(y).length===0&&I(++k.value),D&&setTimeout(()=>{_==!1&&s()},500)}function s(){const e=document.getElementById(`estimate-${o.params.id}`);e&&(e.scrollIntoView({behavior:"smooth"}),e.classList.add("shake"),n())}function n(){T.value.addEventListener("scroll",e=>{e.target.scrollTop>0&&e.target.scrollTop+e.target.clientHeight>e.target.scrollHeight-200&&k.value<N.value&&I(++k.value,!0)})}async function M(){E.value=!0;let e=await h.fetchEstimate(o.params.id);e.data&&(E.value=!1,l.value={...e.data.data})}async function f(){p.value=[],I()}function U(){return r.orderBy==="asc"?(r.orderBy="desc",f(),!0):(r.orderBy="asc",f(),!0)}async function z(){H.openDialog({title:x("general.are_you_sure"),message:x("estimates.confirm_mark_as_sent"),yesLabel:x("general.ok"),noLabel:x("general.cancel"),variant:"primary",hideNoButton:!1,size:"lg"}).then(e=>{F.value=!1,e&&(h.markAsSent({id:l.value.id,status:"SENT"}),l.value.status="SENT",F.value=!0),F.value=!1})}async function q(e){G.openModal({title:x("estimates.send_estimate"),componentName:"SendEstimateModal",id:l.value.id,data:l.value})}async function R(){const e=await h.fetchEstimate(l.value.id);e.data&&(l.value={...e.data.data}),G.openModal({title:x("estimates.create_deposit_invoice"),componentName:"DepositInvoiceModal",id:l.value.id,data:l.value})}function K(){let e=p.value.findIndex(_=>_.id===l.value.id);p.value[e]&&(p.value[e].status="SENT",l.value.status="SENT")}return(e,_)=>{const y=c("BaseButton"),P=c("BasePageHeader"),D=c("BaseIcon"),X=c("BaseInput"),J=c("BaseRadio"),Q=c("BaseInputGroup"),W=c("BaseDropdownItem"),ce=c("BaseDropdown"),me=c("BaseText"),pe=c("BaseEstimateStatusBadge"),_e=c("BaseFormatMoney"),ve=c("router-link"),fe=c("BasePage");return d(),$(Z,null,[t(ke,{onUpdate:K}),t(qe),l.value?(d(),g(fe,{key:0,class:"xl:pl-96 xl:ml-8"},{default:i(()=>{var ee;return[t(P,{title:V.value},{actions:i(()=>[a("div",Ke,[l.value.status==="DRAFT"&&A(C).hasAbilities(A(Y).EDIT_ESTIMATE)?(d(),g(y,{key:0,disabled:F.value,"content-loading":E.value,variant:"primary-outline",onClick:z},{default:i(()=>[S(m(e.$t("estimates.mark_as_sent")),1)]),_:1},8,["disabled","content-loading"])):b("",!0)]),l.value.status!=="DRAFT"&&A(C).hasAbilities(A(Y).CREATE_INVOICE)?(d(),g(y,{key:0,"content-loading":E.value,variant:"primary-outline",class:"text-sm mr-3",onClick:R},{default:i(()=>[S(m(e.$t("estimates.create_deposit_invoice")),1)]),_:1},8,["content-loading"])):b("",!0),l.value.status==="DRAFT"&&A(C).hasAbilities(A(Y).SEND_ESTIMATE)?(d(),g(y,{key:1,"content-loading":E.value,variant:"primary",class:"text-sm",onClick:q},{default:i(()=>[S(m(e.$t("estimates.send_estimate")),1)]),_:1},8,["content-loading"])):b("",!0),t($e,{class:"ml-3",row:l.value},null,8,["row"])]),_:1},8,["title"]),a("div",Xe,[a("div",Je,[a("div",Qe,[t(X,{modelValue:r.searchText,"onUpdate:modelValue":_[0]||(_[0]=u=>r.searchText=u),placeholder:e.$t("general.search"),type:"text",variant:"gray",onInput:_[1]||(_[1]=u=>f())},{right:i(()=>[t(D,{name:"SearchIcon",class:"text-gray-400"})]),_:1},8,["modelValue","placeholder"])]),a("div",We,[t(ce,{class:"ml-3",position:"bottom-start","width-class":"w-45","position-class":"left-0"},{activator:i(()=>[t(y,{size:"md",variant:"gray"},{default:i(()=>[t(D,{name:"FilterIcon"})]),_:1})]),default:i(()=>[a("div",Ye,m(e.$t("general.sort_by")),1),t(W,{class:"flex px-4 py-2 cursor-pointer"},{default:i(()=>[t(Q,{class:"-mt-3 font-normal"},{default:i(()=>[t(J,{id:"filter_estimate_date",modelValue:r.orderByField,"onUpdate:modelValue":[_[2]||(_[2]=u=>r.orderByField=u),f],label:e.$t("reports.estimates.estimate_date"),size:"sm",name:"filter",value:"estimate_date"},null,8,["modelValue","label"])]),_:1})]),_:1}),t(W,{class:"flex px-4 py-2 cursor-pointer"},{default:i(()=>[t(Q,{class:"-mt-3 font-normal"},{default:i(()=>[t(J,{id:"filter_due_date",modelValue:r.orderByField,"onUpdate:modelValue":[_[3]||(_[3]=u=>r.orderByField=u),f],label:e.$t("estimates.due_date"),value:"expiry_date",size:"sm",name:"filter"},null,8,["modelValue","label"])]),_:1})]),_:1}),t(W,{class:"flex px-4 py-2 cursor-pointer"},{default:i(()=>[t(Q,{class:"-mt-3 font-normal"},{default:i(()=>[t(J,{id:"filter_estimate_number",modelValue:r.orderByField,"onUpdate:modelValue":[_[4]||(_[4]=u=>r.orderByField=u),f],label:e.$t("estimates.estimate_number"),value:"estimate_number",size:"sm",name:"filter"},null,8,["modelValue","label"])]),_:1})]),_:1})]),_:1}),t(y,{class:"ml-1",size:"md",variant:"gray",onClick:U},{default:i(()=>[L.value?(d(),g(D,{key:0,name:"SortAscendingIcon"})):(d(),g(D,{key:1,name:"SortDescendingIcon"}))]),_:1})])]),a("div",{ref_key:"estimateListSection",ref:T,class:"h-full overflow-y-scroll border-l border-gray-200 border-solid base-scroll"},[(d(!0),$(Z,null,ie(p.value,(u,ye)=>(d(),$("div",{key:ye},[u?(d(),g(ve,{key:0,id:"estimate-"+u.id,to:`/admin/estimates/${u.id}/view`,class:de(["flex justify-between side-estimate p-4 cursor-pointer hover:bg-gray-100 items-center border-l-4 border-transparent",{"bg-gray-100 border-l-4 border-primary-500 border-solid":O(u.id)}]),style:{"border-bottom":"1px solid rgba(185, 193, 209, 0.41)"}},{default:i(()=>[a("div",Ze,[t(me,{text:u.customer.name,length:30,class:"pr-2 mb-2 text-sm not-italic font-normal leading-5 text-black capitalize truncate"},null,8,["text"]),a("div",et,m(u.estimate_number),1),t(pe,{status:u.status,class:"px-1 text-xs"},{default:i(()=>[S(m(u.status),1)]),_:2},1032,["status"])]),a("div",tt,[t(_e,{amount:u.total,currency:u.customer.currency,class:"block mb-2 text-xl not-italic font-semibold leading-8 text-right text-gray-900"},null,8,["amount","currency"]),a("div",at,m(u.formatted_estimate_date),1)])]),_:2},1032,["id","to","class"])):b("",!0)]))),128)),B.value?(d(),$("div",st,[t(Ie,{class:"h-6 m-1 animate-spin text-primary-400"})])):b("",!0),!((ee=p.value)!=null&&ee.length)&&!B.value?(d(),$("p",ot,m(e.$t("estimates.no_matching_estimates")),1)):b("",!0)],512)]),a("div",lt,[a("iframe",{src:`${j.value}`,class:"flex-1 border border-gray-400 border-solid rounded-md bg-white frame-style"},null,8,nt)])]}),_:1})):b("",!0)],64)}}};export{mt as default};
