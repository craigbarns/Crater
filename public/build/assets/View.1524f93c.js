import{I as se,ad as oe,m as le,l as ne,d as w,K as re,e as f,r as c,o as d,j as b,h as n,b as s,z as S,t as m,a,c as $,F as Z,i as ie,g as h,ab as te,aO as ae,n as de,aa as ge,N as be,M as he,E as xe,P as Be,x as A,R as Y}from"./main.dcc3e423.js";import{_ as $e}from"./EstimateIndexDropdown.3588c7a7.js";import{_ as ke}from"./SendEstimateModal.758988cb.js";import{L as Ie}from"./LoadingIcon.65d8a294.js";import"./mail-driver.9544f8c6.js";const we={class:"flex justify-between w-full"},Se={class:"px-8 py-6"},Ee={key:0,class:"mb-6 p-4 bg-gray-50 rounded-md border border-gray-200"},Te={class:"text-sm font-semibold text-gray-700 mb-3"},Ve={class:"text-gray-600"},De={key:0,class:"text-gray-400"},Me=s("hr",{class:"my-3 border-gray-200"},null,-1),Fe={class:"flex justify-between items-center text-sm font-semibold"},Ae={class:"text-gray-700"},Ce={class:"flex gap-4 mt-2"},Ne={class:"flex items-center cursor-pointer"},Le={class:"ml-2 text-sm text-gray-700"},je={class:"flex items-center cursor-pointer"},Ue={class:"ml-2 text-sm text-gray-700"},ze={class:"relative"},Re={key:1,class:"mt-6 p-4 bg-gray-50 rounded-md border border-gray-200"},Pe={class:"flex justify-between items-center"},Ge={class:"text-sm font-medium text-gray-700"},He={class:"text-lg font-semibold text-gray-900"},Oe={class:"z-0 flex justify-end p-4 border-t border-gray-200 border-solid"},qe={__name:"DepositInvoiceModal",emits:["created"],setup(ue,{emit:P}){const k=se(),G=oe(),C=le(),{t:x}=ne(),r=w(!1),l=re({deposit_type:"percentage",deposit_value:30}),D=f(()=>k.active&&k.componentName==="DepositInvoiceModal"),B=f(()=>k.data||{}),E=f(()=>k.id),_=f(()=>{var t,i;return((i=(t=B.value)==null?void 0:t.customer)==null?void 0:i.currency)||null}),I=f(()=>{var t;return((t=B.value)==null?void 0:t.deposit_invoices)||[]}),N=f(()=>I.value.reduce((t,i)=>t+i.total,0)),T=f(()=>{var i;return(((i=B.value)==null?void 0:i.total)||0)-N.value}),o=f(()=>{var i;const t=((i=B.value)==null?void 0:i.total)||0;return!l.deposit_value||l.deposit_value<=0?0:l.deposit_type==="percentage"?Math.round(t*l.deposit_value/100):Math.round(l.deposit_value)}),H=f(()=>o.value>T.value&&T.value>0?x("estimates.deposit_exceeds_total"):null),L=f(()=>l.deposit_value>0&&o.value>0&&o.value<=T.value&&!r.value);async function O(){if(!!L.value){r.value=!0;try{const t=await G.createDepositInvoice(E.value,{deposit_type:l.deposit_type,deposit_value:l.deposit_value});t.data&&(M(),C.push(`/admin/invoices/${t.data.data.id}/edit`))}catch(t){console.error(t)}finally{r.value=!1}}}function M(){k.closeModal(),setTimeout(()=>{l.deposit_type="percentage",l.deposit_value=30},300)}return(t,i)=>{const j=c("BaseIcon"),F=c("BaseFormatMoney"),y=c("BaseInputGroup"),U=c("BaseInput"),q=c("BaseInputGrid"),z=c("BaseButton"),K=c("BaseModal");return d(),b(K,{show:D.value,onClose:M},{header:n(()=>[s("div",we,[S(m(t.$t("estimates.create_deposit_invoice"))+" ",1),a(j,{name:"XIcon",class:"h-6 w-6 text-gray-500 cursor-pointer",onClick:M})])]),default:n(()=>[s("div",Se,[I.value.length>0?(d(),$("div",Ee,[s("h4",Te,m(t.$t("estimates.existing_deposits")),1),(d(!0),$(Z,null,ie(I.value,p=>(d(),$("div",{key:p.id,class:"flex justify-between items-center text-sm py-1"},[s("span",Ve,[S(m(p.invoice_number)+" ",1),p.deposit_percentage?(d(),$("span",De," ("+m(p.deposit_percentage)+"%) ",1)):h("",!0)]),a(F,{amount:p.total,currency:_.value},null,8,["amount","currency"])]))),128)),Me,s("div",Fe,[s("span",Ae,m(t.$t("estimates.remaining_amount")),1),a(F,{amount:T.value,currency:_.value},null,8,["amount","currency"])])])):h("",!0),a(q,{layout:"one-column"},{default:n(()=>[a(y,{label:t.$t("estimates.deposit_type"),required:""},{default:n(()=>[s("div",Ce,[s("label",Ne,[te(s("input",{"onUpdate:modelValue":i[0]||(i[0]=p=>l.deposit_type=p),type:"radio",value:"percentage",class:"form-radio text-primary-500"},null,512),[[ae,l.deposit_type]]),s("span",Le,m(t.$t("estimates.percentage")),1)]),s("label",je,[te(s("input",{"onUpdate:modelValue":i[1]||(i[1]=p=>l.deposit_type=p),type:"radio",value:"fixed",class:"form-radio text-primary-500"},null,512),[[ae,l.deposit_type]]),s("span",Ue,m(t.$t("estimates.fixed_amount")),1)])])]),_:1},8,["label"]),a(y,{label:l.deposit_type==="percentage"?t.$t("estimates.percentage_value"):t.$t("estimates.deposit_amount"),required:"",error:H.value},{default:n(()=>[s("div",ze,[l.deposit_type==="percentage"?(d(),b(U,{key:0,modelValue:l.deposit_value,"onUpdate:modelValue":i[2]||(i[2]=p=>l.deposit_value=p),type:"number",min:"0.01",max:"100",step:"0.01",class:"mt-1"},null,8,["modelValue"])):(d(),b(U,{key:1,modelValue:l.deposit_value,"onUpdate:modelValue":i[3]||(i[3]=p=>l.deposit_value=p),type:"number",min:"1",step:"1",class:"mt-1"},null,8,["modelValue"]))])]),_:1},8,["label","error"])]),_:1}),o.value>0?(d(),$("div",Re,[s("div",Pe,[s("span",Ge,m(t.$t("estimates.deposit_amount")),1),s("span",He,[a(F,{amount:o.value,currency:_.value},null,8,["amount","currency"])])])])):h("",!0)]),s("div",Oe,[a(z,{class:"mr-3 text-sm",type:"button",variant:"primary-outline",onClick:M},{default:n(()=>[S(m(t.$t("general.cancel")),1)]),_:1}),a(z,{loading:r.value,disabled:!L.value,variant:"primary",type:"button",onClick:O},{left:n(p=>[r.value?h("",!0):(d(),b(j,{key:0,name:"SaveIcon",class:de(p.class)},null,8,["class"]))]),default:n(()=>[S(" "+m(t.$t("estimates.create_deposit_invoice")),1)]),_:1},8,["loading","disabled"])])]),_:1},8,["show"])}}},Ke={class:"mr-3 text-sm"},Xe={class:"fixed top-0 left-0 hidden h-full pt-16 pb-[6.4rem] ml-56 bg-white xl:ml-64 w-88 xl:block"},Je={class:"flex items-center justify-between px-4 pt-8 pb-2 border border-gray-200 border-solid height-full"},Qe={class:"mb-6"},We={class:"flex mb-6 ml-3",role:"group","aria-label":"First group"},Ye={class:"px-4 py-1 pb-2 mb-1 mb-2 text-sm border-b border-gray-200 border-solid"},Ze={class:"flex-2"},et={class:"mt-1 mb-2 text-xs not-italic font-medium leading-5 text-gray-600"},tt={class:"flex-1 whitespace-nowrap right"},at={class:"text-sm not-italic font-normal leading-5 text-right text-gray-600 est-date"},st={key:0,class:"flex justify-center p-4 items-center"},ot={key:1,class:"flex justify-center px-4 mt-5 text-sm text-gray-600"},lt={class:"flex flex-col min-h-0 mt-8 overflow-hidden",style:{height:"75vh"}},nt=["src"],mt={__name:"View",setup(ue){const P=se(),k=oe(),G=ge(),C=be(),{t:x}=ne(),r=w(null),l=he();le();const D=w(!1),B=w(!1),E=w(!1),_=w(null),I=w(1),N=w(1),T=w(null),o=re({orderBy:null,orderByField:null,searchText:null}),H=f(()=>r.value.estimate_number),L=f(()=>o.orderBy==="asc"||o.orderBy==null);f(()=>L.value?x("general.ascending"):x("general.descending"));const O=f(()=>`/estimates/pdf/${r.value.unique_hash}`);f(()=>r.value&&r.value.id?estimate.value.id:null),xe(l,(e,v)=>{e.name==="estimates.view"&&F()}),t(),F(),y=Be.exports.debounce(y,500);function M(e){return l.params.id==e}async function t(e,v=!1){if(B.value)return;let g={};o.searchText!==""&&o.searchText!==null&&o.searchText!==void 0&&(g.search=o.searchText),o.orderBy!==null&&o.orderBy!==void 0&&(g.orderBy=o.orderBy),o.orderByField!==null&&o.orderByField!==void 0&&(g.orderByField=o.orderByField),B.value=!0;let R=await k.fetchEstimates({page:e,...g});B.value=!1,_.value=_.value?_.value:[],_.value=[..._.value,...R.data.data],I.value=e||1,N.value=R.data.meta.last_page;let V=_.value.find(X=>X.id==l.params.id);v==!1&&!V&&I.value<N.value&&Object.keys(g).length===0&&t(++I.value),V&&setTimeout(()=>{v==!1&&i()},500)}function i(){const e=document.getElementById(`estimate-${l.params.id}`);e&&(e.scrollIntoView({behavior:"smooth"}),e.classList.add("shake"),j())}function j(){T.value.addEventListener("scroll",e=>{e.target.scrollTop>0&&e.target.scrollTop+e.target.clientHeight>e.target.scrollHeight-200&&I.value<N.value&&t(++I.value,!0)})}async function F(){E.value=!0;let e=await k.fetchEstimate(l.params.id);e.data&&(E.value=!1,r.value={...e.data.data})}async function y(){_.value=[],t()}function U(){return o.orderBy==="asc"?(o.orderBy="desc",y(),!0):(o.orderBy="asc",y(),!0)}async function q(){G.openDialog({title:x("general.are_you_sure"),message:x("estimates.confirm_mark_as_sent"),yesLabel:x("general.ok"),noLabel:x("general.cancel"),variant:"primary",hideNoButton:!1,size:"lg"}).then(e=>{D.value=!1,e&&(k.markAsSent({id:r.value.id,status:"SENT"}),r.value.status="SENT",D.value=!0),D.value=!1})}async function z(e){P.openModal({title:x("estimates.send_estimate"),componentName:"SendEstimateModal",id:r.value.id,data:r.value})}async function K(){P.openModal({title:x("estimates.create_deposit_invoice"),componentName:"DepositInvoiceModal",id:r.value.id,data:r.value})}function p(){let e=_.value.findIndex(v=>v.id===r.value.id);_.value[e]&&(_.value[e].status="SENT",r.value.status="SENT")}return(e,v)=>{const g=c("BaseButton"),R=c("BasePageHeader"),V=c("BaseIcon"),X=c("BaseInput"),J=c("BaseRadio"),Q=c("BaseInputGroup"),W=c("BaseDropdownItem"),ce=c("BaseDropdown"),me=c("BaseText"),pe=c("BaseEstimateStatusBadge"),_e=c("BaseFormatMoney"),ve=c("router-link"),fe=c("BasePage");return d(),$(Z,null,[a(ke,{onUpdate:p}),a(qe),r.value?(d(),b(fe,{key:0,class:"xl:pl-96 xl:ml-8"},{default:n(()=>{var ee;return[a(R,{title:H.value},{actions:n(()=>[s("div",Ke,[r.value.status==="DRAFT"&&A(C).hasAbilities(A(Y).EDIT_ESTIMATE)?(d(),b(g,{key:0,disabled:D.value,"content-loading":E.value,variant:"primary-outline",onClick:q},{default:n(()=>[S(m(e.$t("estimates.mark_as_sent")),1)]),_:1},8,["disabled","content-loading"])):h("",!0)]),r.value.status!=="DRAFT"&&A(C).hasAbilities(A(Y).CREATE_INVOICE)?(d(),b(g,{key:0,"content-loading":E.value,variant:"primary-outline",class:"text-sm mr-3",onClick:K},{default:n(()=>[S(m(e.$t("estimates.create_deposit_invoice")),1)]),_:1},8,["content-loading"])):h("",!0),r.value.status==="DRAFT"&&A(C).hasAbilities(A(Y).SEND_ESTIMATE)?(d(),b(g,{key:1,"content-loading":E.value,variant:"primary",class:"text-sm",onClick:z},{default:n(()=>[S(m(e.$t("estimates.send_estimate")),1)]),_:1},8,["content-loading"])):h("",!0),a($e,{class:"ml-3",row:r.value},null,8,["row"])]),_:1},8,["title"]),s("div",Xe,[s("div",Je,[s("div",Qe,[a(X,{modelValue:o.searchText,"onUpdate:modelValue":v[0]||(v[0]=u=>o.searchText=u),placeholder:e.$t("general.search"),type:"text",variant:"gray",onInput:v[1]||(v[1]=u=>y())},{right:n(()=>[a(V,{name:"SearchIcon",class:"text-gray-400"})]),_:1},8,["modelValue","placeholder"])]),s("div",We,[a(ce,{class:"ml-3",position:"bottom-start","width-class":"w-45","position-class":"left-0"},{activator:n(()=>[a(g,{size:"md",variant:"gray"},{default:n(()=>[a(V,{name:"FilterIcon"})]),_:1})]),default:n(()=>[s("div",Ye,m(e.$t("general.sort_by")),1),a(W,{class:"flex px-4 py-2 cursor-pointer"},{default:n(()=>[a(Q,{class:"-mt-3 font-normal"},{default:n(()=>[a(J,{id:"filter_estimate_date",modelValue:o.orderByField,"onUpdate:modelValue":[v[2]||(v[2]=u=>o.orderByField=u),y],label:e.$t("reports.estimates.estimate_date"),size:"sm",name:"filter",value:"estimate_date"},null,8,["modelValue","label"])]),_:1})]),_:1}),a(W,{class:"flex px-4 py-2 cursor-pointer"},{default:n(()=>[a(Q,{class:"-mt-3 font-normal"},{default:n(()=>[a(J,{id:"filter_due_date",modelValue:o.orderByField,"onUpdate:modelValue":[v[3]||(v[3]=u=>o.orderByField=u),y],label:e.$t("estimates.due_date"),value:"expiry_date",size:"sm",name:"filter"},null,8,["modelValue","label"])]),_:1})]),_:1}),a(W,{class:"flex px-4 py-2 cursor-pointer"},{default:n(()=>[a(Q,{class:"-mt-3 font-normal"},{default:n(()=>[a(J,{id:"filter_estimate_number",modelValue:o.orderByField,"onUpdate:modelValue":[v[4]||(v[4]=u=>o.orderByField=u),y],label:e.$t("estimates.estimate_number"),value:"estimate_number",size:"sm",name:"filter"},null,8,["modelValue","label"])]),_:1})]),_:1})]),_:1}),a(g,{class:"ml-1",size:"md",variant:"gray",onClick:U},{default:n(()=>[L.value?(d(),b(V,{key:0,name:"SortAscendingIcon"})):(d(),b(V,{key:1,name:"SortDescendingIcon"}))]),_:1})])]),s("div",{ref_key:"estimateListSection",ref:T,class:"h-full overflow-y-scroll border-l border-gray-200 border-solid base-scroll"},[(d(!0),$(Z,null,ie(_.value,(u,ye)=>(d(),$("div",{key:ye},[u?(d(),b(ve,{key:0,id:"estimate-"+u.id,to:`/admin/estimates/${u.id}/view`,class:de(["flex justify-between side-estimate p-4 cursor-pointer hover:bg-gray-100 items-center border-l-4 border-transparent",{"bg-gray-100 border-l-4 border-primary-500 border-solid":M(u.id)}]),style:{"border-bottom":"1px solid rgba(185, 193, 209, 0.41)"}},{default:n(()=>[s("div",Ze,[a(me,{text:u.customer.name,length:30,class:"pr-2 mb-2 text-sm not-italic font-normal leading-5 text-black capitalize truncate"},null,8,["text"]),s("div",et,m(u.estimate_number),1),a(pe,{status:u.status,class:"px-1 text-xs"},{default:n(()=>[S(m(u.status),1)]),_:2},1032,["status"])]),s("div",tt,[a(_e,{amount:u.total,currency:u.customer.currency,class:"block mb-2 text-xl not-italic font-semibold leading-8 text-right text-gray-900"},null,8,["amount","currency"]),s("div",at,m(u.formatted_estimate_date),1)])]),_:2},1032,["id","to","class"])):h("",!0)]))),128)),B.value?(d(),$("div",st,[a(Ie,{class:"h-6 m-1 animate-spin text-primary-400"})])):h("",!0),!((ee=_.value)!=null&&ee.length)&&!B.value?(d(),$("p",ot,m(e.$t("estimates.no_matching_estimates")),1)):h("",!0)],512)]),s("div",lt,[s("iframe",{src:`${O.value}`,class:"flex-1 border border-gray-400 border-solid rounded-md bg-white frame-style"},null,8,nt)])]}),_:1})):h("",!0)],64)}}};export{mt as default};
